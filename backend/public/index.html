<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICD Code Conversion System - Professional Medical Coding Tool</title>
    <meta name="description" content="Professional ICD-10-CM to ICD-9-CM code conversion system with Elixhauser and Charlson comorbidity indices">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #334155;
            line-height: 1.6;
        }

        .header {
            background: #1e3a8a;
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            opacity: 0.95;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .disclaimer {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
        }

        .disclaimer h3 {
            color: #92400e;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .disclaimer p {
            font-size: 0.875rem;
            color: #78350f;
            margin-bottom: 0.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tab:hover {
            color: #1e3a8a;
        }

        .tab.active {
            color: #1e3a8a;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #1e3a8a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .input-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .input-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: #1e3a8a;
            color: white;
        }

        .btn-primary:hover {
            background: #1e40af;
        }

        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .select-field {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .select-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .arrow {
            font-size: 1.5rem;
            color: #64748b;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .result-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .result-card h4 {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 0.5rem;
        }

        .code-description {
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-yellow {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-red {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-green {
            background: #dcfce7;
            color: #166534;
        }

        .conversion-list {
            margin-top: 1rem;
        }

        .conversion-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .conversion-item:last-child {
            margin-bottom: 0;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:hover {
            background: #f8fafc;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            border: 2px solid #22c55e;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            background: #22c55e;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .score-info {
            flex: 1;
        }

        .score-condition {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .score-match {
            font-size: 0.875rem;
            color: #64748b;
        }

        .footer {
            max-width: 1400px;
            margin: 3rem auto 2rem;
            padding: 2rem;
            text-align: center;
            color: #64748b;
            font-size: 0.875rem;
        }

        .footer-stats {
            margin-bottom: 1rem;
        }

        .footer-links a {
            color: #1e3a8a;
            text-decoration: none;
            margin: 0 0.5rem;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: 0.75rem 1rem;
            }

            .input-row {
                flex-direction: column;
            }

            .select-row {
                flex-direction: column;
                align-items: stretch;
            }

            .arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>ICD CODE CONVERSION SYSTEM</h1>
            <div class="status-indicator">
                <span class="status-dot"></span>
                DATABASE ONLINE
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Disclaimer -->
        <div class="disclaimer">
            <h3>‚ö†Ô∏è LEGAL DISCLAIMER</h3>
            <p><strong>Educational Tool Only:</strong> This application is for reference purposes. All codes and conversions must be reviewed and validated by qualified medical professionals. Do not use for diagnoses, treatments, or clinical decisions without proper supervision.</p>
            <p><strong>Data Sources:</strong> Official data from CMS.gov, NBER.org, HCUP-US-AHRQ.gov, PMC-NCBI.NLM.NIH.gov. May contain errors or be outdated. The creator is not a healthcare professional and assumes no liability for its use.</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('lookup')">CODE LOOKUP</button>
            <button class="tab" onclick="switchTab('conversion')">CODE CONVERSION</button>
        </div>

        <!-- Tab 1: Code Lookup -->
        <div id="lookup" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem;">Search ICD Code</h2>
                
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">ICD CODE</label>
                        <input 
                            type="text" 
                            id="searchCode" 
                            class="input-field" 
                            placeholder="E.g., E10.10, I21, A1801"
                            onkeypress="if(event.key==='Enter') searchCode()">
                    </div>
                    <button class="btn btn-primary" onclick="searchCode()">SEARCH</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">CLEAR</button>
                </div>
            </div>

            <!-- Results -->
            <div id="searchResults"></div>
        </div>

        <!-- Tab 2: Code Conversion -->
        <div id="conversion" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem;">Convert ICD Codes</h2>
                
                <div class="select-row">
                    <select id="fromSystem" class="select-field" onchange="updateToSystem()">
                        <option value="icd10">ICD-10-CM</option>
                        <option value="icd9">ICD-9-CM</option>
                    </select>
                    <span class="arrow">‚Üí</span>
                    <select id="toSystem" class="select-field">
                        <option value="icd9">ICD-9-CM</option>
                        <option value="icd10">ICD-10-CM</option>
                    </select>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">SOURCE CODE</label>
                        <input 
                            type="text" 
                            id="convertCode" 
                            class="input-field" 
                            placeholder="Enter code to convert"
                            onkeypress="if(event.key==='Enter') convertCode()">
                    </div>
                    <button class="btn btn-primary" onclick="convertCode()">CONVERT</button>
                    <button class="btn btn-secondary" onclick="clearConvert()">CLEAR</button>
                </div>
            </div>

            <!-- Conversion Results -->
            <div id="conversionResults"></div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-stats">
            <strong>Database Statistics:</strong> 197,047 medical codes | 102,591 conversions | 39 Elixhauser categories | 19 Charlson conditions
        </div>
        <div class="footer-links">
            Powered by Next.js + PostgreSQL | 
            <a href="https://www.cms.gov" target="_blank">CMS</a> |
            <a href="https://www.nber.org" target="_blank">NBER</a> |
            <a href="https://hcup-us.ahrq.gov" target="_blank">HCUP-US</a> |
            <a href="https://pmc.ncbi.nlm.nih.gov" target="_blank">PMC-NCBI</a>
        </div>
    </div>

    <script>
        // API Base URL - Will use relative URLs in production
        const API_BASE = '/api';

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Update TO system when FROM changes
        function updateToSystem() {
            const fromSystem = document.getElementById('fromSystem').value;
            const toSystem = document.getElementById('toSystem');
            toSystem.value = fromSystem === 'icd10' ? 'icd9' : 'icd10';
        }

        // Clear Search
        function clearSearch() {
            document.getElementById('searchCode').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // Clear Convert
        function clearConvert() {
            document.getElementById('convertCode').value = '';
            document.getElementById('conversionResults').innerHTML = '';
        }

        // Search Code
        async function searchCode() {
            const code = document.getElementById('searchCode').value.trim().toUpperCase();
            if (!code) return;

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching database...</p></div>';

            try {
                // Search main code
                const response = await fetch(`${API_BASE}/search?code=${encodeURIComponent(code)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Code not found');
                }

                // Get additional data
                let elixhauserData = null;
                let charlsonData = null;

                if (data.system === 'ICD-10-CM') {
                    try {
                        const elixRes = await fetch(`${API_BASE}/elixhauser?code=${encodeURIComponent(code)}`);
                        if (elixRes.ok) elixhauserData = await elixRes.json();
                    } catch (e) {}

                    try {
                        const charlsonRes = await fetch(`${API_BASE}/charlson?code=${encodeURIComponent(code)}&system=icd10`);
                        if (charlsonRes.ok) charlsonData = await charlsonRes.json();
                    } catch (e) {}
                }

                displaySearchResults(data, elixhauserData, charlsonData);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Display Search Results
        function displaySearchResults(codeData, elixhauser, charlson) {
            const html = `
                <div class="results-grid">
                    <!-- Original Code -->
                    <div class="result-card">
                        <h4>Code Information</h4>
                        <div class="code-display">${codeData.code}</div>
                        <div class="code-description">${codeData.description}</div>
                        <div style="margin-top: 1rem;">
                            <span class="badge badge-blue">${codeData.system}</span>
                            ${codeData.isFamily ? '<span class="badge badge-yellow">FAMILY</span>' : ''}
                        </div>
                    </div>

                    <!-- Elixhauser -->
                    ${elixhauser && elixhauser.categories && elixhauser.categories.length > 0 ? `
                        <div class="result-card">
                            <h4>Elixhauser Comorbidities</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Code</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${elixhauser.categories.map(cat => `
                                            <tr>
                                                <td><strong>${cat.code}</strong></td>
                                                <td>${cat.description}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : `
                        <div class="result-card">
                            <h4>Elixhauser Comorbidities</h4>
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <p>No Elixhauser categories found for this code</p>
                            </div>
                        </div>
                    `}

                    <!-- Charlson -->
                    ${charlson && charlson.score ? `
                        <div class="result-card">
                            <h4>Charlson Comorbidity Index</h4>
                            <div class="score-display">
                                <div class="score-circle">${charlson.score}</div>
                                <div class="score-info">
                                    <div class="score-condition">${charlson.condition}</div>
                                    <div class="score-match">Match Type: ${charlson.matchType}</div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="result-card">
                            <h4>Charlson Comorbidity Index</h4>
                            <div class="empty-state">
                                <div class="empty-state-icon">üíØ</div>
                                <p>No Charlson score found for this code</p>
                            </div>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('searchResults').innerHTML = html;
        }

        // Convert Code
        async function convertCode() {
            const code = document.getElementById('convertCode').value.trim().toUpperCase();
            const fromSystem = document.getElementById('fromSystem').value;
            const toSystem = document.getElementById('toSystem').value;

            if (!code) return;

            const resultsDiv = document.getElementById('conversionResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Converting code...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/convert?code=${encodeURIComponent(code)}&from=${fromSystem}&to=${toSystem}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Conversion failed');
                }

                displayConversionResults(data);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Display Conversion Results
        function displayConversionResults(data) {
            const html = `
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Source Code</h3>
                    <div class="code-display">${data.sourceCode}</div>
                    <div class="code-description">${data.sourceDescription || 'No description available'}</div>
                    <span class="badge badge-blue">${data.sourceSystem}</span>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">
                        Conversions to ${data.conversions[0]?.targetCode ? 
                            (data.conversions[0].targetCode.includes('.') ? 'ICD-10-CM' : 'ICD-9-CM') 
                            : 'Target System'}
                    </h3>
                    
                    ${data.conversions && data.conversions.length > 0 ? `
                        <div class="conversion-list">
                            ${data.conversions.map(conv => `
                                <div class="conversion-item">
                                    <div class="code-display" style="font-size: 1.25rem;">${conv.targetCode}</div>
                                    <div class="code-description">${conv.targetDescription || 'No description available'}</div>
                                    <div style="margin-top: 0.75rem;">
                                        ${conv.approximate ? '<span class="badge badge-yellow">APPROX</span>' : ''}
                                        ${conv.combination ? '<span class="badge badge-blue">COMBO</span>' : ''}
                                        ${conv.noMap ? '<span class="badge badge-red">NO MAP</span>' : ''}
                                        ${!conv.approximate && !conv.combination && !conv.noMap ? '<span class="badge badge-green">EXACT</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <p>No conversions found for this code</p>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('conversionResults').innerHTML = html;
        }

        // Load example on page load (optional)
        window.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ ICD Code Conversion System - Ready');
        });
    </script>
</body>
</html>
