/**
 * API Endpoint: /api/convert
 * Convert ICD codes between ICD-10 and ICD-9
 * Supports family conversion with .x notation (e.g., I50.x â†’ 428.x)
 */

import { NextRequest, NextResponse } from 'next/server';
import { sql, handleDbError } from '../../../lib/db';

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const code = searchParams.get('code');
    const from = searchParams.get('from'); // icd10 or icd9
    const to = searchParams.get('to'); // icd9 or icd10

    if (!code || !from || !to) {
      return NextResponse.json(
        { error: 'Code, from, and to parameters are required' },
        { status: 400 }
      );
    }

    // Check if user wants family conversion with .x notation (e.g., I50.x)
    const isFamilyConversion = code.includes('.x') || code.endsWith('x');
    
    // Remove dots from ICD codes (stored without dots in DB)
    let cleanCode = code.trim().toUpperCase().replace(/\./g, '');
    if (isFamilyConversion) {
      cleanCode = cleanCode.replace(/X$/g, ''); // Remove trailing X
    }

    // ICD-10 to ICD-9 - Family Conversion
    if (from === 'icd10' && to === 'icd9' && isFamilyConversion) {
      // Get all codes in the family
      const familyCodes = await sql`
        SELECT code, description
        FROM icd10_codes
        WHERE code LIKE ${cleanCode + '%'}
        ORDER BY code
        LIMIT 100
      `;

      if (familyCodes.length === 0) {
        return NextResponse.json(
          { error: 'No codes found in this family', code: cleanCode },
          { status: 404 }
        );
      }

      // Get all conversions for the family
      const familyConversions = await sql`
        SELECT DISTINCT
          m.icd9_code as target_code,
          m.icd10_code as source_code,
          ic.description as source_description
        FROM icd10_to_icd9_mapping m
        JOIN icd10_codes ic ON m.icd10_code = ic.code
        WHERE m.icd10_code LIKE ${cleanCode + '%'}
        ORDER BY m.icd9_code ASC
      `;

      // Group by ICD-9 family (get the prefix)
      const icd9Families = new Set();
      familyConversions.forEach(conv => {
        // Extract family prefix (e.g., 428 from 42810)
        const prefix = conv.target_code.substring(0, 3);
        icd9Families.add(prefix);
      });

      return NextResponse.json({
        sourceCode: cleanCode,
        sourceCodeOriginal: code,
        sourceSystem: 'ICD-10-CM',
        targetSystem: 'ICD-9-CM',
        isFamily: true,
        isFamilyConversion: true,
        sourceFamilyCount: familyCodes.length,
        sourceFamilyCodes: familyCodes.map(c => ({
          code: c.code,
          description: c.description
        })),
        targetFamilies: Array.from(icd9Families).map(prefix => `${prefix}.x`),
        targetFamiliesCount: icd9Families.size,
        allConversions: familyConversions.map(c => ({
          sourceCode: c.source_code,
          sourceDescription: c.source_description,
          targetCode: c.target_code
        })),
        totalConversions: familyConversions.length
      });
    }

    // ICD-10 to ICD-9
    if (from === 'icd10' && to === 'icd9') {
      const conversions = await sql`
        SELECT 
          m.icd10_code as source_code,
          ic.description as source_description,
          m.icd9_code as target_code,
          m.approximate,
          m.no_map,
          m.combination,
          m.scenario,
          m.choice_list
        FROM icd10_to_icd9_mapping m
        JOIN icd10_codes ic ON m.icd10_code = ic.code
        WHERE m.icd10_code = ${cleanCode}
        ORDER BY m.approximate ASC, m.icd9_code ASC
      `;

      if (conversions.length === 0) {
        return NextResponse.json(
          { error: 'No conversions found for this code', code: cleanCode },
          { status: 404 }
        );
      }

      return NextResponse.json({
        sourceCode: cleanCode,
        sourceSystem: 'ICD-10-CM',
        sourceDescription: conversions[0].source_description,
        targetSystem: 'ICD-9-CM',
        conversions: conversions.map(c => ({
          targetCode: c.target_code,
          approximate: c.approximate,
          noMap: c.no_map,
          combination: c.combination,
          scenario: c.scenario,
          choiceList: c.choice_list
        })),
        totalCount: conversions.length
      });
    }

    // ICD-9 to ICD-10 - Family Conversion
    if (from === 'icd9' && to === 'icd10' && isFamilyConversion) {
      // Get all codes in the family
      const familyCodes = await sql`
        SELECT code
        FROM icd9_codes
        WHERE code LIKE ${cleanCode + '%'}
        ORDER BY code
        LIMIT 100
      `;

      if (familyCodes.length === 0) {
        return NextResponse.json(
          { error: 'No codes found in this family', code: cleanCode },
          { status: 404 }
        );
      }

      // Get all conversions for the family
      const familyConversions = await sql`
        SELECT DISTINCT
          m.icd10_code as target_code,
          m.icd9_code as source_code,
          ic.description as target_description
        FROM icd9_to_icd10_mapping m
        JOIN icd10_codes ic ON m.icd10_code = ic.code
        WHERE m.icd9_code LIKE ${cleanCode + '%'}
        ORDER BY m.icd10_code ASC
      `;

      // Group by ICD-10 family (get the prefix)
      const icd10Families = new Set();
      familyConversions.forEach(conv => {
        // Extract family prefix (e.g., I50 from I5010)
        const prefix = conv.target_code.substring(0, 3);
        icd10Families.add(prefix);
      });

      return NextResponse.json({
        sourceCode: cleanCode,
        sourceCodeOriginal: code,
        sourceSystem: 'ICD-9-CM',
        targetSystem: 'ICD-10-CM',
        isFamily: true,
        isFamilyConversion: true,
        sourceFamilyCount: familyCodes.length,
        sourceFamilyCodes: familyCodes.map(c => ({
          code: c.code
        })),
        targetFamilies: Array.from(icd10Families).map(prefix => `${prefix}.x`),
        targetFamiliesCount: icd10Families.size,
        allConversions: familyConversions.map(c => ({
          sourceCode: c.source_code,
          targetCode: c.target_code,
          targetDescription: c.target_description
        })),
        totalConversions: familyConversions.length
      });
    }

    // ICD-9 to ICD-10
    if (from === 'icd9' && to === 'icd10') {
      const conversions = await sql`
        SELECT 
          m.icd9_code as source_code,
          m.icd10_code as target_code,
          ic.description as target_description,
          m.approximate,
          m.no_map,
          m.combination,
          m.scenario,
          m.choice_list
        FROM icd9_to_icd10_mapping m
        JOIN icd10_codes ic ON m.icd10_code = ic.code
        WHERE m.icd9_code = ${cleanCode}
        ORDER BY m.approximate ASC, m.icd10_code ASC
      `;

      if (conversions.length === 0) {
        return NextResponse.json(
          { error: 'No conversions found for this code', code: cleanCode },
          { status: 404 }
        );
      }

      return NextResponse.json({
        sourceCode: cleanCode,
        sourceSystem: 'ICD-9-CM',
        targetSystem: 'ICD-10-CM',
        conversions: conversions.map(c => ({
          targetCode: c.target_code,
          targetDescription: c.target_description,
          approximate: c.approximate,
          noMap: c.no_map,
          combination: c.combination,
          scenario: c.scenario,
          choiceList: c.choice_list
        })),
        totalCount: conversions.length
      });
    }

    return NextResponse.json(
      { error: 'Invalid conversion direction. Use from=icd10&to=icd9 or from=icd9&to=icd10' },
      { status: 400 }
    );

  } catch (error) {
    console.error('Conversion error:', error);
    return NextResponse.json(
      handleDbError(error),
      { status: 500 }
    );
  }
}
